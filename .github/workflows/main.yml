name: Windows Chrome RD

on:
  workflow_dispatch:

jobs:
  windows:
    runs-on: ubuntu-latest
    timeout-minutes: 35000
    
    steps:
      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Start Windows 10
        run: |
          docker run -d --name windows --privileged \
            -e VERSION="win10" \
            -e RAM_SIZE="8G" \
            -e CPU_CORES="4" \
            -p 8006:8006 \
            -p 3389:3389 \
            --device=/dev/kvm \
            dockurr/windows
          echo "Windows starting..."
          sleep 900

      - name: Setup Tunnel
        uses: AnimMouse/setup-cloudflared@v2

      - name: Expose Windows
        run: |
          cloudflared tunnel --url http://localhost:8006 2>&1 | tee tunnel.log &
          sleep 20
          URL=$(grep -oP 'https://[a-z0-9-]+.trycloudflare.com' tunnel.log | head -1)
          echo "## Windows 10 Ready" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "URL: $URL" >> $GITHUB_STEP_SUMMARY
          echo "Username: docker" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Install Chrome RD in Windows PowerShell:" >> $GITHUB_STEP_SUMMARY
          echo "Invoke-WebRequest -Uri https://dl.google.com/dl/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi -OutFile C:crd.msi" >> $GITHUB_STEP_SUMMARY
          echo "msiexec /i C:crd.msi /quiet" >> $GITHUB_STEP_SUMMARY
          echo "Windows URL: $URL"
          while true; do
            docker ps | grep windows || docker start windows
            sleep 300
          done
